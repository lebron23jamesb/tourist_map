import json
import os
import webbrowser

def build_highlight_map():
    file_name = "china_5a_full_merged.json"
    if not os.path.exists(file_name):
        print("错误：未找到数据文件")
        return

    with open(file_name, 'r', encoding='utf-8') as f:
        data = json.load(f)

    starts = [
        {"name": "广州", "coords": [113.264, 23.129]},
        {"name": "深圳", "coords": [114.057, 22.543]},
        {"name": "河源", "coords": [114.697, 23.746]}
    ]

    html_content = f"""
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>中国5A景区-高亮信息面板地图</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
html, body, #map {{ height:100%; margin:0; padding:0; font-family:"Microsoft YaHei"; }}
.scenic-label {{
    background:none; border:none; box-shadow:none;
    font-weight:bold; font-size:12px;
    color:#2196F3;  /* 景点文字颜色，和省份不同 */
    text-shadow: 1px 1px 0 #fff;
    white-space:nowrap; pointer-events:auto; cursor:pointer;
    transition: all 0.2s;
}}
.label-red {{ color:#FF0000; font-size:12px; }}
.label-normal {{ color:#2196F3; font-weight:500; }}
.label-highlight {{ color:#FF8C00; font-weight:bold; font-size:14px; }}
.province-name-label {{
    background:none; border:none; box-shadow:none;
    font-weight:900; pointer-events:none; text-align:center;
    color: rgba(0,0,0,0.2); /* 保持省份文字原有颜色 */
}}
.start-node {{
    background:#000; color:#fff; padding:3px 8px;
    border-radius:4px; font-size:13px; font-weight:bold;
    border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,0.4);
    z-index:2000;
}}
#info-panel {{
    position:absolute; top:10px; right:10px;
    width:220px; min-height:100px; background:#fff;
    border:1px solid #ccc; padding:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
    z-index:5000; font-size:13px;
}}
.dist-title {{ font-weight:bold; color:#d32f2f; margin-bottom:5px; }}
.dist-line {{ display:flex; justify-content:space-between; margin:2px 0; }}
.dist-city {{ font-weight:bold; }}
.dist-num {{ color:#2196F3; font-weight:bold; }}
</style>
</head>
<body>
<div id="map"></div>
<div id="info-panel">悬浮景点查看信息</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map', {{ zoomControl:true }}).setView([34,108],5);
L.tileLayer('https://{{s}}.basemaps.cartocdn.com/light_all/{{z}}/{{x}}/{{y}}{{r}}.png').addTo(map);

const scenicData = {json.dumps(data, ensure_ascii=False)};
const starts = {json.dumps(starts, ensure_ascii=False)};
const startLatLngs = starts.map(s => L.latLng(s.coords[1], s.coords[0]));
const labelList = [];

// 省份底色和文字
fetch('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json')
.then(res => res.json())
.then(geo => {{
    const colors = ['#fbb4ae','#b3cde3','#ccebc5','#decbe4','#fed9a6','#ffffcc','#e5d8bd','#fddaec'];
    function getStyle(str,pool){{ let hash=0; for(let i=0;i<str.length;i++) hash=str.charCodeAt(i)+((hash<<5)-hash); return pool[Math.abs(hash)%pool.length]; }}
    L.geoJSON(geo, {{
        style: f => ({{ fillColor:getStyle(f.properties.name,colors), weight:1.5, opacity:1, color:'#fff', fillOpacity:0.5 }})
    }}).addTo(map);
    geo.features.forEach(f => {{
        const name = f.properties.name;
        const cp = f.properties.center || f.properties.centroid;
        if(!cp) return;
        L.marker([cp[1], cp[0]], {{
            icon: L.divIcon({{
                className:'province-name-label',
                html:`<div style="font-family:'Microsoft YaHei'; font-size:48px;">${{name}}</div>`,
                iconSize:[250,60]
            }}), interactive:false
        }}).addTo(map);
    }});
}});

// 固定信息面板更新函数
function updateInfo(item, dot, labelEl) {{
    if(window.lastHighlight){{
        window.lastHighlight.setStyle({{radius: window.lastHighlight.originalRadius, fillColor: window.lastHighlight.originalColor}});
        window.lastHighlight.labelEl.classList.remove("label-highlight");
    }}
    dot.setStyle({{radius: dot.options.radius + 4, fillColor:"#FF8C00"}});
    labelEl.classList.add("label-highlight");
    window.lastHighlight = dot;
    window.lastHighlight.labelEl = labelEl;

    let html = `<div class="dist-title">${{item.name}} (${{item.year}})</div>`;
    starts.forEach((s,idx)=>{{
        const d = (map.distance(L.latLng(item.coords[1],item.coords[0]), startLatLngs[idx])/1000).toFixed(0);
        html += `<div class="dist-line"><span class="dist-city">到${{s.name}}:</span><span class="dist-num">${{d}} km</span></div>`;
    }});
    document.getElementById('info-panel').innerHTML = html;
}}

// 渲染景区
scenicData.forEach(item => {{
    if(!item.coords) return;
    const latlng = L.latLng(item.coords[1], item.coords[0]);
    const isFirst = (item.year == 2007);

    const dot = L.circleMarker(latlng, {{
        radius:isFirst?6:4,
        fillColor:isFirst?"#FF0000":"#2196F3",
        color:"#fff", weight:1, fillOpacity:0.9
    }}).addTo(map);

    const label = L.marker(latlng, {{
        icon:L.divIcon({{
            className:isFirst?"scenic-label label-red":"scenic-label label-normal",
            html:item.name,
            iconSize:[item.name.length*12,20]
        }})
    }}).addTo(map);

    dot.originalRadius = dot.options.radius;
    dot.originalColor = dot.options.fillColor;

    dot.on('mouseover',()=>updateInfo(item,dot,label.getElement()));
    label.getElement().addEventListener('mouseover',()=>updateInfo(item,dot,label.getElement()));
    labelList.push({{el:label, latlng:latlng, priority:isFirst?2:1, name:item.name}});
}});

// 出发点
starts.forEach(pt => {{
    L.marker([pt.coords[1], pt.coords[0]], {{
        icon:L.divIcon({{
            className:'dummy',
            html:`<div class="start-node">${{pt.name}}</div>`,
            iconSize:[60,25]
        }}), zIndexOffset:5000
    }}).addTo(map);
}});

// 标签防碰撞
function refresh() {{
    const zoom = map.getZoom();
    if(zoom<6){{ labelList.forEach(l=>l.el.setOpacity(0)); return; }}
    labelList.sort((a,b)=>b.priority-a.priority);
    const box=[];
    labelList.forEach(l => {{
        const p = map.latLngToLayerPoint(l.latlng);
        const w = l.name.length*12, h=20;
        const rect = {{x1:p.x-w/2, y1:p.y-h, x2:p.x+w/2, y2:p.y}};
        let overlap=false;
        for(let r of box){{ if(!(rect.x1>r.x2||rect.x2<r.x1||rect.y1>r.y2||rect.y2<r.y1)){{overlap=true; break;}} }}
        if(!overlap){{ l.el.setOpacity(1); box.push(rect); }} else {{ l.el.setOpacity(0); }}
    }});
}}
map.on('zoomend moveend', refresh);
</script>
</body>
</html>
"""

    output_file = "china_5a_highlight_panel_map_mobile.html"
    with open(output_file, "w", encoding="utf-8") as f:
        f.write(html_content)
    print(f"完成！已生成地图：{output_file}")
    webbrowser.open('file://' + os.path.realpath(output_file))

if __name__ == "__main__":
    build_highlight_map()
